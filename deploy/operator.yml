apiVersion: v1
kind: Template
metadata:
  name: xjoin-operator
parameters:
  - name: IMAGE_TAG
    value: latest
  - name: IMAGE
    value: quay.io/cloudservices/xjoin-operator-index
  - name: TARGET_NAMESPACE
    value: xjoin
  - name: RECONCILE_INTERVAL
    value: "120"
  - name: VALIDATION_INTERVAL
    value: "1800"
  - name: VALIDATION_INTERVAL_INIT
    value: "60"
  - name: VALIDATION_PERCENTAGE_THRESHOLD
    value: "5"
  - name: VALIDATION_PERCENTAGE_THRESHOLD_INIT
    value: "5"
  - name: VALIDATION_ATTEMPTS_THRESHOLD
    value: "3"
  - name: VALIDATION_ATTEMPTS_THRESHOLD_INIT
    value: "30"
  - name: CONNECT_CLUSTER
    value: "xjoin-kafka-connect-strimzi"
  - name: ES_CONNECTOR_TASKS_MAX
    value: "50"

objects:
  - apiVersion: operators.coreos.com/v1
    kind: OperatorGroup
    metadata:
      name: xjoin-operator-group
    spec:
      targetNamespaces:
        - ${TARGET_NAMESPACE}

  - apiVersion: operators.coreos.com/v1alpha1
    kind: CatalogSource
    metadata:
      name: xjoin-operator-source
    spec:
      sourceType: grpc
      image: ${IMAGE}:${IMAGE_TAG}

  - apiVersion: operators.coreos.com/v1alpha1
    kind: Subscription
    metadata:
      name: xjoin-subscription
    spec:
      channel: alpha
      name: xjoin-operator
      source: xjoin-operator-source
      sourceNamespace: ${TARGET_NAMESPACE}

  - apiVersion: v1
    kind: ConfigMap
    metadata:
      name: xjoin
    data:
      standard.interval: ${RECONCILE_INTERVAL}
      validation.interval: ${VALIDATION_INTERVAL}
      validation.attempts.threshold: ${VALIDATION_ATTEMPTS_THRESHOLD}
      validation.percentage.threshold: ${VALIDATION_PERCENTAGE_THRESHOLD}
      init.validation.interval: ${VALIDATION_INTERVAL_INIT}
      init.validation.attempts.threshold: ${VALIDATION_ATTEMPTS_THRESHOLD_INIT}
      init.validation.percentage.threshold: ${VALIDATION_PERCENTAGE_THRESHOLD_INIT}
      connect.cluster: ${CONNECT_CLUSTER}
      elasticsearch.connector.tasks.max: ${ES_CONNECTOR_TASKS_MAX}
      elasticsearch.connector.max.in.flight.requests: "1"
      elasticsearch.connector.max.retries: "8"
      elasticsearch.connector.retry.backoff.ms: "100"
      elasticsearch.connector.batch.size: "100"
      elasticsearch.connector.max.buffered.records: "500"
      elasticsearch.connector.linger.ms: "100"
      debezium.connector.tasks.max: "1"
      debezium.connector.max.batch.size: "10"
      debezium.connector.max.queue.size: "1000"
      debezium.connector.poll.interval.ms: "100"
      kafka.topic.partitions: "500"
      kafka.topic.replicas: "2"
      jenkins.managed.version: "v1.160"


  # TODO: move this into the bundle itself
  # depends on https://github.com/operator-framework/operator-sdk/pull/4137
  - apiVersion: v1
    kind: Service
    metadata:
      name: xjoin-operator
      labels:
        control-plane: xjoin-controller-manager
    spec:
      ports:
        - name: https
          protocol: TCP
          port: 8080
          targetPort: 8080
      selector:
        control-plane: xjoin-controller-manager
