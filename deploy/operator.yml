apiVersion: v1
kind: Template
metadata:
  name: xjoin-operator
parameters:
  - name: IMAGE_TAG
    value: latest
  - name: IMAGE
    value: quay.io/cloudservices/xjoin-operator-index
  - name: TARGET_NAMESPACE
    value: xjoin
  - name: RECONCILE_INTERVAL
    value: "120"
  - name: VALIDATION_INTERVAL
    value: "600"
  - name: VALIDATION_INTERVAL_INIT
    value: "120"
  - name: VALIDATION_PERCENTAGE_THRESHOLD
    value: "5"
  - name: VALIDATION_PERCENTAGE_THRESHOLD_INIT
    value: "5"
  - name: VALIDATION_ATTEMPTS_THRESHOLD
    value: "10"
  - name: VALIDATION_ATTEMPTS_THRESHOLD_INIT
    value: "60"
  - name: CONNECT_CLUSTER
    value: "xjoin-kafka-connect-strimzi"
  - name: ES_CONNECTOR_TASKS_MAX
    value: "50"
  - name: JENKINS_MANAGED_VERSION
    value: "v1.0"
  - name: KAFKA_TOPIC_PARTITIONS
    value: "500"
  - name: KAFKA_TOPIC_REPLICAS
    value: "2"
  - name: ES_CONNECTOR_MAX_IN_FLIGHT_REQUESTS
    value: "1"
  - name: ES_CONNECTOR_MAX_RETRIES
    value: "8"
  - name: ES_CONNECTOR_RETRY_BACKOFF_MS
    value: "100"
  - name: ES_CONNECTOR_BATCH_SIZE
    value: "100"
  - name: ES_CONNECTOR_MAX_BUFFERED_RECORDS
    value: "500"
  - name: ES_CONNECTOR_LINGER_MS
    value: "100"
  - name: ES_INDEX_REPLICAS
    value: "1"
  - name: ES_INDEX_SHARDS
    value: "3"
  - name: DEBEZIUM_CONNECTOR_TASKS_MAX
    value: "1"
  - name: DEBEZIUM_CONNECTOR_MAX_BATCH_SIZE
    value: "10"
  - name: DEBEZIUM_CONNECTOR_MAX_QUEUE_SIZE
    value: "1000"
  - name: DEBEZIUM_CONNECTOR_POLL_INTERVAL_MS
    value: "100"
  - name: HBI_DB_SSL
    value: "disable"
  - name: LOG_LEVEL
    value: "info"
  - name: KAFKA_TOPIC_RETENTION_BYTES
    value: "256000000"
  - name: FULL_VALIDATION_NUM_THREADS
    value: "10"
  - name: FULL_VALIDATION_CHUNK_SIZE
    value: "500"

objects:
  - apiVersion: operators.coreos.com/v1
    kind: OperatorGroup
    metadata:
      name: xjoin-operator-group
    spec:
      targetNamespaces:
        - ${TARGET_NAMESPACE}

  - apiVersion: operators.coreos.com/v1alpha1
    kind: CatalogSource
    metadata:
      name: xjoin-operator-source
    spec:
      sourceType: grpc
      image: ${IMAGE}:${IMAGE_TAG}

  - apiVersion: operators.coreos.com/v1alpha1
    kind: Subscription
    metadata:
      name: xjoin-subscription
    spec:
      channel: alpha
      name: xjoin-operator
      source: xjoin-operator-source
      sourceNamespace: ${TARGET_NAMESPACE}
      config:
        env:
          - name: LOG_LEVEL
            value: "${LOG_LEVEL}"
        resources:
          limits:
            cpu: 4
            memory: 8Gi
          requests:
            cpu: 1
            memory: 1Gi

  - apiVersion: v1
    kind: ConfigMap
    metadata:
      name: xjoin
    data:
      standard.interval: ${RECONCILE_INTERVAL}
      validation.interval: ${VALIDATION_INTERVAL}
      validation.attempts.threshold: ${VALIDATION_ATTEMPTS_THRESHOLD}
      validation.percentage.threshold: ${VALIDATION_PERCENTAGE_THRESHOLD}
      init.validation.interval: ${VALIDATION_INTERVAL_INIT}
      init.validation.attempts.threshold: ${VALIDATION_ATTEMPTS_THRESHOLD_INIT}
      init.validation.percentage.threshold: ${VALIDATION_PERCENTAGE_THRESHOLD_INIT}
      connect.cluster: ${CONNECT_CLUSTER}
      elasticsearch.connector.tasks.max: ${ES_CONNECTOR_TASKS_MAX}
      elasticsearch.connector.max.in.flight.requests: ${ES_CONNECTOR_MAX_IN_FLIGHT_REQUESTS}
      elasticsearch.connector.max.retries: ${ES_CONNECTOR_MAX_RETRIES}
      elasticsearch.connector.retry.backoff.ms: ${ES_CONNECTOR_RETRY_BACKOFF_MS}
      elasticsearch.connector.batch.size: ${ES_CONNECTOR_BATCH_SIZE}
      elasticsearch.connector.max.buffered.records: ${ES_CONNECTOR_MAX_BUFFERED_RECORDS}
      elasticsearch.connector.linger.ms: ${ES_CONNECTOR_LINGER_MS}
      elasticsearch.index.replicas: ${ES_INDEX_REPLICAS}
      elasticsearch.index.shards: ${ES_INDEX_SHARDS}
      debezium.connector.tasks.max: ${DEBEZIUM_CONNECTOR_TASKS_MAX}
      debezium.connector.max.batch.size: ${DEBEZIUM_CONNECTOR_MAX_BATCH_SIZE}
      debezium.connector.max.queue.size: ${DEBEZIUM_CONNECTOR_MAX_QUEUE_SIZE}
      debezium.connector.poll.interval.ms: ${DEBEZIUM_CONNECTOR_POLL_INTERVAL_MS}
      kafka.topic.partitions: ${KAFKA_TOPIC_PARTITIONS}
      kafka.topic.replicas: ${KAFKA_TOPIC_REPLICAS}
      jenkins.managed.version: ${JENKINS_MANAGED_VERSION}
      hbi.db.ssl: ${HBI_DB_SSL}
      kafka.topic.retention.bytes: ${KAFKA_TOPIC_RETENTION_BYTES}
      full.validation.num.threads: ${FULL_VALIDATION_NUM_THREADS}
      full.validation.chunk.size: ${FULL_VALIDATION_CHUNK_SIZE}


  # TODO: move this into the bundle itself
  # depends on https://github.com/operator-framework/operator-sdk/pull/4137
  - apiVersion: v1
    kind: Service
    metadata:
      name: xjoin-operator
      labels:
        control-plane: controller-manager
    spec:
      ports:
        - name: https
          protocol: TCP
          port: 8080
          targetPort: 8080
      selector:
        control-plane: controller-manager
